

  
  <!-- Main Content Section -->

  <div class="row">    
    <div class="small-0 medium-2 large-3 columns">
      <div id="categoryImage">
        <% case @idea.category %>
        <% when "1" %>
        <%= image_tag('sales.png') %>
        <% when "2" %>
        <%= image_tag('production.png') %>
        <% when "3" %>
        <%= image_tag('money.png') %>
        <% else %>
        <%= image_tag('social.jpg') %>
        <% end %>
      </div>
    </div>

<div class"ideaTitle">
    <div class="small-12 medium-6 large-6 columns">
      <h1><%= @idea.title %></h1>
      <h4>By <%= @idea.user.name %></h4>
      <p><%= @idea.long_desc %></p>
      <br/>
      <div><%= render "comments/form" %></div>
    </div>
    <div class="small-0 medium-4 large-3 columns">
      <div><%= render "ideas/tapSlider" %></div>
      <div class="tapCount">
        <h5>Current Coffer:</h5>
        <div class="small-0 medium-2 large-3 columns">&nbsp</div>
        <h1><span style="border-radius:50%; border:solid black 5px;padding:10px"><%= @idea.coffer %></span><h1>
      </div>
    </div>   
  </div>
</div>

<!-- Hidden forms for updating current_user.wallet and @idea.coffer -->
<%= form_for(current_user, remote: true) do |f| %>
  <%= f.number_field :wallet, style: "#{'display:none'}" %>
<% end %>

<%= form_for(@idea, remote: true) do |f| %>
  <%= f.number_field :coffer, style: "#{'display:none'}" %>
<% end %>

<!-- Comment Wall -->
<div class="row">
  <div class="small-0 medium-2 large-3 columns">&nbsp</div>
  <div class="small-12 medium-6 large-6 columns">
    <div class="comment-wall"></div>
  </div>
  <div class="small-0 medium-4 large-3 columns">&nbsp</div>
</div>


<!-- Idea Template -->
<div id="templates">
  <script type="text/template" class="comment">
    <div class="row panel radius comment">
      <div class="small-1 columns"></div>
      <div class="small-10 small columns">
        <p><%= @idea.user.name %></p>
        <p>{ body }</p>
      </div>
      <div class="small-1 columns"></div>
    </div>
  </script>
</div>

<% content_for :javascript do %>
<script type="text/javascript">
(function () {

  ////////////////////////
  // TAPS CONTRIBUTIONS //
  ////////////////////////

  // Set POST route for new transactions
  g.userTransactionUrl = '<%= user_transaction_api_path(current_user) %>'

  // Update contribution amount on slide event
  var $tapsSlider = $('input#taps-slider');
  
  $($tapsSlider).change(function(e) {
    e.preventDefault;
    var newVal = $(this).val();
    $('#contribution-amount').text(newVal);
  });

  // Update database when contribution made
  $('#contribute-taps').on('click', function(e) {
    e.preventDefault;
    var contributionAmount = +$tapsSlider.val();
    var ideaID = '<%= @idea.id %>';

    // Deduct contribution amount from current_user.wallet
    var $userWallet = $('input#user_wallet');
    var walletBegBal = +$userWallet.val();
    var walletNewBal = (walletBegBal - contributionAmount);
    $userWallet.val(walletNewBal);

    // Add contribution amount to @idea.coffer
    var $ideaCoffer = $('input#idea_coffer');
    var cofferBegBal = +$ideaCoffer.val();
    $ideaCoffer.val(cofferBegBal + contributionAmount);

    // POST request for new transaction and trigger PUT request for user and idea
    var newTransaction = {
      amount: contributionAmount,
      idea_id: ideaID
    };
    $.post(g.userTransactionUrl, newTransaction, function() {
      $('form.edit_user, form.edit_idea').trigger('submit');
      console.log("Transaction posted to database.");
      // Reset defaults without needing refresh
      $('span#wallet-max').text(walletNewBal);
      $('input#taps-slider').attr('max', walletNewBal);
      $tapsSlider.val(0);
      $('#contribution-amount').text(0);
    });
  });
  //////////////
  // COMMENTS //
  //////////////

  // Set POST route for new comments
  g.ideaCommentsUrl = '<%= idea_comment_api_path(@idea) %>';

  // Create comments model instance
  var ideaComments = new Comment();

  var currentUserID = <%= current_user.id %>;

  // Initialize CommentForm and CommentWall presenters
  var formPresenter = new CommentForm({
    root: $('form.new-comment'),
    comments: ideaComments,
    user_id: currentUserID
  });

  var wallPresenter = new CommentWall({
    root: $('.comment-wall'),
    comments: ideaComments
  });

  var serverComments = <%= raw @idea.comments.to_json %>;

  ideaComments.initializeComments(serverComments);

})();
</script>
<% end %>